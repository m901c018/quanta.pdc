@model m_FormPartial
@{
    ViewData["Title"] = "表單資訊"; 
}

<div class="page-content">
    <div class="page-info container">
        <div class="row">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">PDC - CNS平台</a></li>
                        <li class="breadcrumb-item active" aria-current="page">表單申請</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <div class="main-wrapper container">
        <!-- 表頭 -->
        <div class="row">
            <div class="col-lg-12">
                <form asp-action="FormApply" enctype="multipart/form-data" id="FormApply">
                    @*<div asp-validation-summary="All"></div>*@
                    <div class="card">
                        <div class="card-body">
                            <p class="card-title">@ViewData["Title"]</p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>申請單編號</label>
                                        <input type="text" class="form-control" placeholder="(系統自動產生)" disabled="disabled">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>申請日期</label>
                                        <input type="text" class="form-control" disabled="disabled" value="@DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>申請單狀態</label>
                                        <input type="text" class="form-control" asp-for="m_PDC_Form.FormStatus" value="未送件" disabled="disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>公司別</label>
                                        <input type="text" class="form-control" asp-for="m_PDC_Form.CompCode" value="QCI">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>事業群</label>
                                        <input type="text" class="form-control" asp-for="m_PDC_Form.BUCode" value="BU_Test">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>申請者</label>
                                        <input type="text" class="form-control" asp-for="m_PDC_Form.ApplierID" value="TestUser" disabled="disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>PCB Layout Status</label>
                                        <select class="select2 form-control" asp-for="m_PDC_Form.PCBLayoutStatus" >
                                            <option value="New">New</option>
                                            <option value="RFQ">RFQ</option>
                                            <option value="Modify">Modify</option>
                                        </select>
                                        @*<input type="email" class="form-control" value="New" placeholder="New/RFQ/Modify" disabled="disabled">*@
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>是否為MB</label>
                                        <div class="input-group">
                                            <div class="custom-control custom-radio" >
                                                <input class="custom-control-input" asp-for="m_PDC_Form.IsMB" id="IsMBYes" type="radio"  value="true" >
                                                <label class="custom-control-label" for="exampleRadios3" style="padding-right: 10px;" onclick="ClickMB('IsMBYes')">
                                                    MB
                                                </label>
                                            </div>
                                            <div class="custom-control custom-radio" >
                                                <input class="custom-control-input" asp-for="m_PDC_Form.IsMB" id="IsMBNo" type="radio"  value="false" >
                                                <label class="custom-control-label" for="exampleRadios3" onclick="ClickMB('IsMBNo')">
                                                    其他
                                                </label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <span asp-validation-for="m_PDC_Form.IsMB" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>PCB Type</label>
                                        @*<input type="email" class="form-control" placeholder="Non-HDI/HDI/Anylayer/FPC/Rigid-flex" disabled="disabled">*@
                                        <select class="select2 form-control" asp-for="m_PDC_Form.PCBType">
                                            <option value="Non-HDI">Non-HDI</option>
                                            <option value="HDI">HDI</option>
                                            <option value="Anylayer">Anylayer</option>
                                            <option value="FPC">FPC</option>
                                            <option value="Rigid-flex">Rigid-flex</option>
                                        </select>
                                        <div class="input-group">
                                            <span asp-validation-for="m_PDC_Form.PCBType" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Project</label>
                                        <input type="text" asp-for="m_PDC_Form.ProjectName" class="form-control">
                                        <div class="input-group">
                                            <span asp-validation-for="m_PDC_Form.ProjectName" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Board Type</label>
                                        <input type="text" asp-for="m_PDC_Form.BoardTypeName" class="form-control">
                                        <div class="input-group">
                                            <span asp-validation-for="m_PDC_Form.BoardTypeName" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Rev.</label>
                                        <input type="text" asp-for="m_PDC_Form.Revision" class="form-control">
                                        <div class="input-group">
                                            <span asp-validation-for="m_PDC_Form.Revision" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-title">Constraint Files</p>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>1. BRD 壓縮檔(限制Zip格式)</span>
                                        <div>
                                            <span asp-validation-for="m_UplpadBRDFile" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-file mb-3">
                                            <input type="file" asp-for="m_UplpadBRDFile" class="custom-file-input" id="UplpadBRDFile" accept=".zip" >
                                            <label id="UplpadBRDFileLabel" class="custom-file-label" for="UplpadBRDFile" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        @if (Model.m_BRDFile != null)
                                        {
                                            <a href="#">@Model.m_BRDFile.FileName (@Model.m_BRDFile.CreatorDate.ToString("yyyy/MM/dd"))</a>
                                            <a href="javascript:return false;" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        }
                                    </div>
                                    <div class="col-md-2">

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>2. Constraint Excel</span>
                                        <div>
                                            <span asp-validation-for="m_UplpadExcelFile" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-file mb-3">
                                            <input type="file" asp-for="m_UplpadExcelFile" class="custom-file-input" id="UplpadExcelFile" accept=".xlsx">
                                            <label id="UplpadExcelFileLabel" class="custom-file-label" for="UplpadExcelFile" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        @if (Model.m_ExcelFile != null)
                                        {
                                            <a href="#">@Model.m_ExcelFile.FileName (@Model.m_ExcelFile.CreatorDate.ToString("yyyy/MM/dd"))</a>
                                            <a href="javascript:return false;" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        }
                                    </div>
                                    <div class="col-md-2">
                                        <a href="javascript:window.open('@Url.Action("ExcelEdit", "Excel")?IsOnlyOnline=true')" class="btn btn-outline-success" style=" padding: 4px 25px;" id="mail-compose">另開無檔編輯</a>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>3. pstchip.dat</span>
                                        <div>
                                            <span asp-validation-for="m_UplpadpstchipFile" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-file mb-3">
                                            <input type="file" asp-for="m_UplpadpstchipFile" class="custom-file-input" id="UplpadpstchipFile" accept=".dat">
                                            <label id="UplpadpstchipFileLabel" class="custom-file-label" for="UplpadpstchipFile" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        @if (Model.m_pstchipFile != null)
                                        {
                                            <a href="#">@Model.m_pstchipFile.FileName (@Model.m_pstchipFile.CreatorDate.ToString("yyyy/MM/dd"))</a>
                                            <a href="javascript:return false;" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        }
                                    </div>
                                    <div class="col-md-2">

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>4. pstxnet.dat</span>
                                        <div>
                                            <span asp-validation-for="m_UplpadpstxnetFile" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-file mb-3">
                                            <input type="file" asp-for="m_UplpadpstxnetFile" class="custom-file-input" id="UplpadpstxnetFile" accept=".dat">
                                            <label id="UplpadpstxnetFileLabel" class="custom-file-label" for="UplpadpstxnetFile" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        @if (Model.m_pstxnetFile != null)
                                        {
                                            <a href="#">@Model.m_pstxnetFile.FileName (@Model.m_pstxnetFile.CreatorDate.ToString("yyyy/MM/dd"))</a>
                                            <a href="javascript:return false;" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        }
                                    </div>
                                    <div class="col-md-2">

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>5. pstxprt.dat</span>
                                        <div>
                                            <span asp-validation-for="m_UplpadpstxprtFile" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-file mb-3">
                                            <input type="file" asp-for="m_UplpadpstxprtFile" class="custom-file-input" id="UplpadpstxprtFile" accept=".dat">
                                            <label id="UplpadpstxprtFileLabel" class="custom-file-label" for="UplpadpstxprtFile" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        @if (Model.m_pstxprtFile != null)
                                        {
                                            <a href="#">@Model.m_pstxprtFile.FileName (@Model.m_pstxprtFile.CreatorDate.ToString("yyyy/MM/dd"))</a>
                                            <a href="javascript:return false;" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        }
                                    </div>
                                    <div class="col-md-2">

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>6. 其他檔案</span>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-file mb-3">
                                            <input type="file" asp-for="m_UplpadOtherFile" class="custom-file-input" id="UplpadOtherFile">
                                            <label id="UplpadOtherFileLabel" class="custom-file-label" for="UplpadOtherFile" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3" style="padding-bottom: 10px;">
                                        @if (Model.m_Other != null)
                                        {
                                            <a href="#">@Model.m_Other.FileName (@Model.m_Other.CreatorDate.ToString("yyyy/MM/dd"))</a>
                                            <a href="javascript:return false;" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        }
                                        @*<li>
                                            <a href="#">ChangeLog.xlsx (2020/10/23)</a>
                                            <a href="#" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        </li>
                                        <li>
                                            <a href="#">Kickoff.msg (2020/10/23)</a>
                                            <a href="#" alt="刪除"><i style="color: #f05154;" class="fas fa-trash-alt"></i></a>
                                        </li>*@
                                    </div>
                                    <div class="col-md-2">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span>意見</span>
                                    </div>
                                    <div class="col-md-4">
                                        <textarea class="form-control" id="StageResult" asp-for="Result" rows="3"></textarea>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="list-group">
                                            <a href="javascript:return false;" onclick="SetResult(this)" class="list-group-item list-group-item-action active" aria-current="true">增加減 Region</a>
                                            <a href="javascript:return false;" onclick="SetResult(this)" class="list-group-item list-group-item-action">增加減 TP、VIA</a>
                                            <a href="javascript:return false;" onclick="SetResult(this)" class="list-group-item list-group-item-action">其他</a>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="hidden" asp-for="IsSendApply" id="IsSeedApply" value="false" />
                                        @*<a href="javascript:return false;" class="btn btn-outline-success" style=" padding: 4px 25px;" id="mail-compose">暫存</a>*@
                                        <button type="submit" class="btn btn-outline-success" id="SaveApply" style=" padding: 4px 25px;">暫存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body" style="padding-bottom: 0px;">
                        <p class="card-title">Stackup</p>
                        <div class="row align-items-end">
                            <div class="col-md-10">
                                <span style="color: #ffc107;">*請務必使用最新版範本</span>
                            </div>
                            <div class="col-md-1" style="text-align: center;">
                                <br>unit: mil
                            </div>
                            <div class="col-md-1"  style="text-align: center;">
                                總板厚<br><label id="ThicknessTotal">0.00</label>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="grid">
                                <thead class="thead-dark">
                                    <tr>
                                        <th scope="col" style="width: 5%;">Layer</th>
                                        <th scope="col" style="width: 15%;">疊構類別</th>
                                        <th scope="col" style="width: 10%;">Name</th>
                                        <th scope="col" style="width: 20%;">HIGH SPEED GROUP NAME</th>
                                        <th scope="col" style="width: 10%;">線寬</th>
                                        <th scope="col" style="width: 10%;">間距</th>
                                        <th scope="col" style="width: 15%;">疊構</th>
                                        <th scope="col" style="width: 10%;">板厚</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   
                                </tbody>
                            </table>
                        </div>
                        <div class="card-body">
                            <p class="card-title">Stackup 檢測</p>
                            <div class="row">
                                <div class="col-md-8">
                                    <textarea class="form-control" id="ErrorMsg" rows="3" disabled="disabled"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <a href="javascript:window.open('@Url.Action("ExcelEdit", "Excel")')" class="btn btn-outline-success" style=" padding: 4px 25px; display:none" id="OpenOnlineEdit">開啟線上編輯</a>
                                    @*<a href="#" class="btn btn-outline-warning" style=" padding: 4px 25px;" id="mail-compose">執行檢測</a>*@
                                    <br />
                                    <br />
                                    <a href="javascript:return false;" class="btn btn-outline-danger" style=" padding: 4px 25px;display:none" onclick="DownloadError()" id="downloadError">下載錯誤明細</a>
                                    <a href="javascript:return false;" class="btn btn-outline-warning" style=" padding: 4px 25px;display:none" onclick="SeedApply()" id="SendApply">送出申請</a>
                                    @*<a href="javascript:return false;" class="btn btn-outline-info" style=" padding: 4px 25px;display:none" id="disApply">抽單</a>*@
                                </div>
                            </div>
                        </div>
                        @*<div class="card-body">
                            <p class="card-title">檢核結果</p>
                            <div class="row">
                                <div class="col-md-8">
                                    <textarea class="form-control" id="exampleFormControlTextarea1" rows="3">Failed，錯誤訊息(xxxxx)</textarea>
                                </div>
                                <div class="col-md-4">
                                    <a href="#" class="btn btn-outline-danger" style=" padding: 4px 25px;" id="mail-compose">下載錯誤明細</a>
                                    <a href="#" class="btn btn-outline-warning" style=" padding: 4px 25px;" id="mail-compose">送出申請</a>
                                    <a href="#" class="btn btn-outline-info" style=" padding: 4px 25px;" id="mail-compose">抽單</a>
                                </div>
                            </div>
                        </div>*@
                    </div>
                </div>
            </div>
        </div>
   
        <!-- End of Main -->
    </div>

</div>

@section Styles{
    <!-- data tables css -->
    <link rel="stylesheet" href="~/assets/plugins/data-tables/css/datatables.min.css">
}

@section Scripts {
    <!-- datatable Js -->
    <script src="~/assets/plugins/data-tables/js/datatables.min.js"></script>
    <script src="~/assets/js/pages/tbl-datatable-custom.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#grid').DataTable({
                lengthChange: false,
                info: false,
                searching: false,
                scrollX: false,
                bPaginate: false, // 顯示換頁
                ordering: false,  // 是否顯示header排序
            });
            


        });

        function SetResult(obj) {
            $('#StageResult').val($(obj).text());
            $('.list-group-item').removeClass('active');
            $(obj).addClass('active');
        }

        //點擊Radio
        function ClickMB(obj) {
            $('#' + obj).trigger('click');
        }

        function SeedApply() {
            $('#IsSeedApply').val('true');
            $('#SaveApply').trigger('click');
        }

        $('input[id=UplpadBRDFile]').change(function () {
            $('#UplpadBRDFileLabel').text($(this).val());
        });

        $('input[id=UplpadExcelFile]').change(function () {
            $('#UplpadExcelFileLabel').text($(this).val());

            $('body').removeClass('no-loader');
            uploadFile();
        });

        $('input[id=UplpadpstchipFile]').change(function () {
            $('#UplpadpstchipFileLabel').text($(this).val());
        });

        $('input[id=UplpadpstxnetFile]').change(function () {
            $('#UplpadpstxnetFileLabel').text($(this).val());
        });

        $('input[id=UplpadpstxprtFile]').change(function () {
            $('#UplpadpstxprtFileLabel').text($(this).val());
        });

        $('input[id=UplpadOtherFile]').change(function () {
            $('#UplpadOtherFileLabel').text($(this).val());
        });

        //上傳Excel
        function uploadFile() {
            
            var formData = new FormData();
            formData.append('file', $('#UplpadExcelFile')[0].files[0]); // myFile is the input type="file" control

            var _url = '@Url.Action("UploadFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false,  // tell jQuery not to set contentType
                success: function (result) {
                    if (result.status == "400") {
                        alert(result.ErrorMessage);
                        $('#UplpadExcelFileLabel').text('Choose file');
                    }
                    else {
                        //$('#grid tbody').html(result);
                        var dt = $('#grid').DataTable();
                        dt.clear().draw();

                        $.each(result, function (index, row) {
                            dt.row.add([
                                row[0]
                                , row[1]
                                , row[2]
                                , row[3]
                                , row[4]
                                , row[5]
                                , row[6]
                                , row[7]
                            ]);
                        });
                        dt.draw(false);
                        //計算總版厚
                        GetTotal();
                        //驗證
                        SaveCheckFile();

                        
                    }
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                    $('#lefile').val('');
                    $('#FileID').val('');
                    $('body').addClass('no-loader');
                }
            });
        }
        //計算總版厚
        function GetTotal() {
            var Sum = 0.00;
            $.each($('#grid > tbody > tr'), function (index, row) {
                var value = $(this).find('td').last().text();
                if ($.isNumeric(value))
                {
                    Sum += Number(value);
                }
            });
            $('#ThicknessTotal').text(Sum.toFixed(2));
        }
        //驗證Excel內容
        function SaveCheckFile() {
            $('#OpenOnlineEdit').hide();
            $('#downloadError').hide();
            $('#SendApply').hide();
            $('#disApply').hide();

            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};

                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).text();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("SaveCheckFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    $('#ErrorMsg').text(result);

                    if (result != "") {
                        //顯示訊息
                        $('#ErrorMsg').text(result);
                        $('#OpenOnlineEdit').show();
                        $('#downloadError').show();
                    }
                    else {
                        $('#ErrorMsg').text('驗證通過!');
                        $('#SendApply').show();
                        $('#downloadExp').show();
                    }
                    
                    $('body').addClass('no-loader');
                },
                error: function (jqXHR) {
                    $('body').addClass('no-loader');
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        //下載錯誤訊息
        function DownloadError() {
            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};
                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).text();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("DownloadError", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    window.location.href = "@Url.RouteUrl(new { Controller = "Excel", Action = "DownloadErrorFile" })/?FileName=" + result + "&RealFileName=" + $('#FileID').val();
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }
    </script>
}