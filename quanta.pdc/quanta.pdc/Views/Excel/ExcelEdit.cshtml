@model m_ExcelPartial
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>ExcelEdit</title>

    <link rel="stylesheet" href="~/assets/plugins/data-tables/css/datatables.min.css">


</head>
<body>
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">

                <div class="page-content">
                    <div class="page-info container">
                        <div class="row">
                            <div class="col">
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="#">PDC - CNS平台</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">StackUp編輯</li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
                    <div class="main-wrapper container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body" style="padding-bottom: 0px;">
                                        <p class="card-title">Stackup</p>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <a href="javascript:return false;" class="btn btn-outline-success" style=" padding: 4px 25px;" id="mail-compose" onclick="AddRow()">新增欄位</a>
                                                <a href="javascript:return false;" class="btn btn-outline-success" style=" padding: 4px 25px;" id="mail-compose" onclick="DeleteRow()">刪除欄位</a>
                                            </div>
                                            <div class="col-md-7"></div>
                                            <div class="col-md-1" style="text-align: center;">
                                                <br>unit: mil
                                            </div>
                                            <div class="col-md-1" style="text-align: center;">
                                                總板厚<br><label id="ThicknessTotal">0.00</label>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="grid">
                                                <thead class="thead-dark">
                                                    <tr>
                                                        <th scope="col" style="width: 8%;">Layer</th>
                                                        <th scope="col" style="width: 15%;">疊構類別</th>
                                                        <th scope="col" style="width: 10%;">Name</th>
                                                        <th scope="col" style="width: 20%;">HIGH SPEED GROUP NAME</th>
                                                        <th scope="col" style="width: 10%;">線寬</th>
                                                        <th scope="col" style="width: 10%;">間距</th>
                                                        <th scope="col" style="width: 15%;">疊構</th>
                                                        <th scope="col" style="width: 7%;">板厚</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @for (int i = 0; i <= Model.ExcelSheetDts[0].Rows.Count - 1; i++)
                                                    {
                                                        <tr>
                                                            @for (int j = 0; j <= Model.StackupColumnList.Count - 1; j++)
                                                            {
                                                                if (j == (Model.StackupColumnList.Count - 1))
                                                                {
                                                                    <td>
                                                                        <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" onchange="GetTotal()" />
                                                                    </td>
                                                                }
                                                                else if (j == (Model.StackupColumnList.Count - 2))
                                                                {
                                                                    <td>
                                                                        <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" />
                                                                    </td>
                                                                }
                                                                else if (i == 0)
                                                                {
                                                                    <td>
                                                                        <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" disabled="disabled" />
                                                                    </td>
                                                                }
                                                                else if (i == 1)
                                                                {
                                                                    if (j == 4 || j == 5)
                                                                    {
                                                                        <td>
                                                                            <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" />
                                                                        </td>
                                                                    }
                                                                    else
                                                                    {
                                                                        <td>
                                                                            <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" disabled="disabled" />
                                                                        </td>
                                                                    }
                                                                }
                                                                else if (i == (Model.ExcelSheetDts[0].Rows.Count - 2))
                                                                {
                                                                    if (j == 0 || j == 4 || j == 5)
                                                                    {
                                                                        <td>
                                                                            <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" />
                                                                        </td>
                                                                    }
                                                                    else
                                                                    {
                                                                        <td>
                                                                            <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" disabled="disabled" />
                                                                        </td>
                                                                    }
                                                                }
                                                                else if (i == (Model.ExcelSheetDts[0].Rows.Count - 1))
                                                                {
                                                                    <td>
                                                                        <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" disabled="disabled" />
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td>
                                                                        <input type="email" class="form-control" style="padding:12px 15px;" value="@Model.ExcelSheetDts[0].Rows[i][j]" />
                                                                    </td>
                                                                }
                                                            }
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-title">Stackup 檢測</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <textarea class="form-control" id="ErrorMsg" rows="3" disabled="disabled"></textarea>
                                                    <br>
                                                    <span>※離開此畫面後，無法在次下載檔案！</span>
                                                </div>
                                                <div class="col-md-6">
                                                    @*<a href="#" class="btn btn-success" style=" padding: 4px 25px;" id="mail-compose">線上修改</a>*@
                                                    @*<input type="button" onclick="AddRow()" id="uploadExcel" value="新增欄位" class="btn-success" />
                                                        <input type="button" onclick="DeleteRow()" id="uploadExcel" value="刪除欄位" class="btn-success" />*@

                                                    <a href="javascript:return false;" class="btn btn-outline-warning" style=" padding: 4px 25px;" id="mail-compose" onclick="SaveCheckFile()">執行檢測</a>
                                                    <br />
                                                    <br />
                                                    <a href="javascript:return false;" class="btn btn-outline-danger" style=" padding: 4px 25px;" id="mail-compose" onclick="DownloadError()">下載錯誤明細</a>
                                                    <a href="javascript:return false;" class="btn btn-outline-info" style=" padding: 4px 25px;" id="mail-compose" onclick="DownloadCheckFile()">下載 CNS Excel</a>
                                                    <a href="javascript:return false;" class="btn btn-outline-info" style=" padding: 4px 25px;" id="mail-compose">下載 cns.exp</a>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End of Main -->
                </div>

            </div>
        </div>
    </div>

    <script src="~/assets/plugins/data-tables/js/datatables.min.js"></script>
    <script src="~/assets/js/pages/tbl-datatable-custom.js"></script>
    <script src="~/assets/js/vendor-all.min.js"></script>
    <script src="~/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="~/assets/js/pcoded.min.js"></script>
    <script src="~/assets/plugins/notification/js/bootstrap-growl.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#grid').DataTable({
                lengthChange: false,
                info: false,
                searching: false,
                scrollX: false,
                bPaginate: false, // 顯示換頁
                ordering: false,  // 是否顯示header排序
            });

            $(window).bind("beforeunload", function () { 
                var data = new Array();

                $.each($('#grid tbody tr'), function (index,row) {
                    $.each($(row).find('td'), function (colIndex,col) {
                        var StackupDetalList = {};
                        StackupDetalList.IndexNo = index;
                        StackupDetalList.ColumnValue = $(col).find('input:eq(0)').val();
                        StackupDetalList.StackupColumnID = (colIndex + 1);
                        data.push(StackupDetalList);
                    });
                });

                var ViewModel = { StackupDetalList: data };

                window.opener.returnData(ViewModel);
                //return confirm("Do you really want to close?"); 
            });
        });

        function GetTotal() {
            //var table = $('#grid').DataTable();
            var Sum = 0.00;
            $.each($('#grid > tbody > tr'), function (index, row) {
                var value = $(this).find('td').last().find('input').val();
                if ($.isNumeric(value))
                {
                    Sum += Number(value);
                }
            });
            $('#ThicknessTotal').text(Sum.toFixed(2));
        }

        function SaveCheckFile() {
            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};
                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).find('input:eq(0)').val();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("SaveCheckFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    $('#ErrorMsg').text(result);
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        function DownloadCheckFile() {
            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};
                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).find('input:eq(0)').val();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("DownloadCheckFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    window.location.href = "@Url.RouteUrl(new { Controller = "Excel", Action = "Download" })/?fileName=" + result;
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        function DownloadError() {
            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};
                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).find('input:eq(0)').val();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("DownloadError", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    window.location.href = "@Url.RouteUrl(new { Controller = "Excel", Action = "DownloadErrorFile" })/?FileName=" + result + "&RealFileName=" + $('#FileID').val();
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        function AddRow() {
            if ($('#grid').length == 0) {
                alert("請先上傳驗證檔案");
                return;
            }
            var copyrow1 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 4).clone();
            copyrow1.find('td').each(function( index ){
                $(this).find('input').val('');
                $(this).find('input').prop("disabled", false);
            });
            var copyrow2 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 3).clone();
            copyrow2.find('td').each(function( index ){
                $(this).find('input').val('');
                $(this).find('input').prop("disabled", false);
            });
            var copyrow3 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 2).clone();
            var copyrow4 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 1).clone();


            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 2).remove();
            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 1).remove();

            $('#grid > tbody').append(copyrow1);
            $('#grid > tbody').append(copyrow2);
            $('#grid > tbody').append(copyrow3);
            $('#grid > tbody').append(copyrow4);
        }

        function DeleteRow() {
            if ($('#grid').length == 0) {
                alert("請先上傳驗證檔案");
                return;
            }

            if ($('#grid > tbody > tr').length <= 5) {
                alert("已沒可刪除資料");
                return;
            }

            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 4).remove();
            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 3).remove();
        }
    </script>
</body>
</html>
