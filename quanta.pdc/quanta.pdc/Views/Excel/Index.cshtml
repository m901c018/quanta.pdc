@model m_ExcelPartial
@{
    ViewData["Title"] = "Check驗證";
}

<!-- [ Main Content ] start -->
    <section>
        <!--class="pcoded-main-container"-->
        <div class="pcoded-wrapper">
            <div class="pcoded-content">
                <div class="pcoded-inner-content">
                    <div class="page-content">
                        <div class="page-info container">
                            <div class="row">
                                <div class="col">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="#">PDC - CNS平台</a></li>
                                            <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <div class="main-wrapper container">
                            @*<div class="row">
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-body" style="padding-bottom: 0px;">
                                            <p class="card-title">快速連結</p>
                                            <ul class="inbox-list list-unstyled">
                                                @foreach (var item in Model.FastLinkList)
                                                {
                                                    PDC_File File = Model.FastLinkFileList.Where(x => x.SourceID == item.ParameterID).FirstOrDefault();
                                                    if (File.FileCategory == 1)
                                                    {
                                                        string Path = Url.RouteUrl(new { Controller = "Excel", Action = "Download" }) + "/?fileName=" + File.FileFullName;
                                                        <li>
                                                            <div class="info-list">
                                                                <div style="flex: 15; text-align: left; display: inline-block; ">
                                                                    <span>@item.ParameterText</span>
                                                                </div>

                                                                <div style=" text-align: right; display: inline-block; ">
                                                                    <a href="javascript:return false;" onclick="window.location.href='@Path'" class="btn btn-outline-info" style=" padding: 4px 25px;" id="mail-compose">下載</a>
                                                                </div>
                                                            </div>

                                                        </li>
                                                    }
                                                    else
                                                    {
                                                        <li>
                                                            <div class="info-list">
                                                                <div style="flex: 15; text-align: left; display: inline-block; ">
                                                                    <span>@item.ParameterText</span>
                                                                </div>

                                                                <div style=" text-align: right; display: inline-block; ">
                                                                    <a href="javascript:window.open('@File.FileName')" class="btn btn-outline-info" style=" padding: 4px 25px;" id="mail-compose">開啟</a>
                                                                </div>
                                                            </div>

                                                        </li>
                                                    }
                                                }

                                                <li>
                                                    <div class="info-list">
                                                        <div style="flex: 15; text-align: left; display: inline-block; ">
                                                            <span>Constraint 範本 (@(Model.m_CNSSampleFile != null ? Model.m_CNSSampleFile.CreatorDate.ToString("yyyy/MM/dd") : "2021/01/01"))</span>
                                                            <span style="color: #ffc107;">*請務必使用最新版範本</span>
                                                        </div>

                                                        <div style=" text-align: right; display: inline-block; ">
                                                            <a href="javascript:return false;" class="btn btn-outline-info" onclick="window.location.href='@Url.Action("DownloadSample", "Excel")'" style=" padding: 4px 25px;" id="mail-compose">下載</a>
                                                        </div>
                                                    </div>

                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>*@
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <p class="card-title">使用說明</p>
                                            <div class="form-group">

                                                <ul>
                                                    <li>此為線上驗證，完成後仍須提出申請套用 CNS(Constraint)。</li>
                                                    <li>線上驗證系統不保留上傳檔案，請自行備份留存。</li>
                                                    <li>正在廣達內部 Layout 的專案，於檢測無誤後，請將 CNS Excel、cns.exp 下載後寄給所負責的 Layout 工程師處理。</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-title">上傳檔案</p>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <span>1. pstxnet.dat</span>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="custom-file mb-3">
                                                            <input type="file" class="custom-file-input" id="datFile" name="filename" accept=".dat">
                                                            <label class="custom-file-label" for="datFile" id="datshowCover" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <span>2. Constraint</span>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="custom-file mb-3">
                                                            <input type="file" class="custom-file-input" id="lefile" name="filename" accept=".xlsx">
                                                            <label class="custom-file-label" for="lefile" id="showCover" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <a href="javascript:window.open('@Url.Action("ExcelEdit", "Excel")?IsOnlyOnline=true')" class="btn btn-outline-success" style=" padding: 4px 25px;" id="mail-compose">另開無檔編輯</a>
                                                        <input type="hidden" id="FileID" />
                                                    </div>

                                                </div>
                                            </div>
                                            @*<div class="form-group">
                                                <form asp-action="TestUploadFile" enctype="multipart/form-data" >
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <input type="file" class="custom-file-input" id="file" name="file">
                                                            <label class="custom-file-label" for="file" id="showCover" style="background-color: #1F2128; color: #adb5bd;">Choose file</label>
                                                            <input type="submit" value="測試" />
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>*@
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-body" style="padding-bottom: 0px;">
                                            <p class="card-title">Stackup</p>
                                            <div class="row align-items-end">
                                                <div class="col-md-9">
                                                    <span style="color: red;">*STACK UP皆以「mil」填寫，取至小數點後兩位，超過將以四捨五入處理。</span>
                                                    <button class="btn btn-outline-success" id="showLayer" onclick="GridShow(this)">顯示疊構</button>
                                                </div>
                                                <div class="col-md-1" style="text-align: center; ">
                                                    <br>unit: mil
                                                </div>
                                                <div class="col-md-2" style="text-align: center;vertical-align:bottom">
                                                    總板厚 = <label id="ThicknessTotal">0.00</label>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-hover" id="grid">
                                                    <thead class="thead-dark">
                                                        <tr>
                                                            <th scope="col" style="width: 5%;">層別<br />(LAYER)</th>
                                                            <th scope="col" style="width: 15%;">LAYOUT疊構<br />(Stack up Type)</th>
                                                            <th scope="col" style="width: 7%;">名稱<br />（NAME）</th>
                                                            <th scope="col" style="width: 15%;">代碼<br /> (NAME CODE)</th>
                                                            <th scope="col" style="width: 13%;">線寬<br />(LINE WIDTH)</th>
                                                            <th scope="col" style="width: 13%;">間距<br />(SPACING)</th>
                                                            <th scope="col" style="width: 25%;">PCB疊構<br />(Stack up)</th>
                                                            <th scope="col" style="width: 7%;">板厚<br />(Thickness)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-title">Stackup 檢測</p>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <textarea class="form-control" id="ErrorMsg" rows="3" disabled="disabled"></textarea>
                                                        <br>
                                                        <span>※離開此畫面後，無法在次下載檔案！</span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        @*<a href="#" class="btn btn-success" style=" padding: 4px 25px;" id="mail-compose">線上修改</a>*@
                                                        @*<input type="button" onclick="AddRow()" id="uploadExcel" value="新增欄位" class="btn-success" />
                                                        <input type="button" onclick="DeleteRow()" id="uploadExcel" value="刪除欄位" class="btn-success" />*@

                                                        <a href="javascript:window.open('@Url.Action("ExcelEdit", "Excel")')" class="btn btn-outline-success" style=" padding: 4px 25px; display:none" id="OpenOnlineEdit">開啟線上編輯</a>
                                                        @*<a href="javascript:return false;" class="btn btn-outline-warning" style=" padding: 4px 25px;" id="mail-compose" onclick="SaveCheckFile()">執行檢測</a>*@
                                                        <br />
                                                        <br />
                                                        <a href="javascript:return false;" class="btn btn-outline-danger" style=" padding: 4px 25px;display:none" id="downloadError" onclick="DownloadError()">下載錯誤明細</a>
                                                        <a href="javascript:return false;" class="btn btn-outline-info" style=" padding: 4px 25px;display:none" id="downloadCNS" onclick="DownloadCheckFile()">下載 CNS Excel</a>
                                                        <a href="javascript:return false;" class="btn btn-outline-info" style=" padding: 4px 25px;display:none" id="downloadExp">下載 cns.exp</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End of Main -->
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" id="RuleCategory" value="@Model.m_ExcelRule.ParameterText" />
        <input type="hidden" id="RuleValue" value="@Model.m_ExcelRule.ParameterValue" />
        <input type="hidden" id="RuleDesc" value="@Model.m_ExcelRule.ParameterDesc" />
    </section>
<!-- [ Main Content ] end -->


@section Styles{
    <!-- data tables css -->
    <link rel="stylesheet" href="~/assets/plugins/data-tables/css/datatables.min.css">
}

@section Scripts {
    <!-- datatable Js -->
    <script src="~/assets/plugins/data-tables/js/datatables.min.js"></script>
    <script src="~/assets/js/pages/tbl-datatable-custom.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            //$('#grid').DataTable({
            //    lengthChange: false,
            //    info: false,
            //    searching: false,
            //    scrollX: false,
            //    bPaginate: false, // 顯示換頁
            //    ordering: false,  // 是否顯示header排序
            //});
        });

        $('input[id=lefile]').change(function () {
            $('#showCover').text($(this).val());
            
            $('body').removeClass('no-loader');
            uploadFile();
        });

        $('input[id=datFile]').change(function () {
            $('#datshowCover').text($(this).val());
        });

        //檢查線寬線距
        function CheckNumRule() {
            var IsCheck = true;
            //取得規則
            var RuleCategory = $('#RuleCategory').val();
            var RuleValue = parseFloat($('#RuleValue').val());
            var RuleDesc = $('#RuleDesc').val();
            //有設定才檢查
            if (RuleCategory && RuleValue) {
                $('#grid > tbody > tr').each(function (index, row) {
                    //去除除數字內容
                    var Line = $(row).find('td').eq(4).text().replace(/[^0-9.]/ig, "");          
                    var width = $(row).find('td').eq(5).text().replace(/[^0-9.]/ig, "");    
                    if ($.isNumeric(Line)) {
                        if (RuleCategory == "1") {
                            if (parseFloat(Line) <= RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "2") {
                            if (parseFloat(Line) < RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "3") {
                            if (parseFloat(Line) = RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "4") {
                            if (parseFloat(Line) > RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "5") {
                            if (parseFloat(Line) >= RuleValue)
                                IsCheck = false;
                        }
                    }

                    if ($.isNumeric(width)) {
                        if (RuleCategory == "1") {
                            if (parseFloat(width) <= RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "2") {
                            if (parseFloat(width) < RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "3") {
                            if (parseFloat(width) = RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "4") {
                            if (parseFloat(width) > RuleValue)
                                IsCheck = false;
                        }

                        if (RuleCategory == "5") {
                            if (parseFloat(width) >= RuleValue)
                                IsCheck = false;
                        }
                    }
                });

                if (IsCheck == false) {
                    alert(RuleDesc);
                }
            }
        }

        function GetTotal() {
            var Sum = 0.00;
            $.each($('#grid > tbody > tr'), function (index, row) {
                var value = $(this).find('td').last().text();
                if ($.isNumeric(value))
                {
                    Sum += Number(value);
                }
            });
            $('#ThicknessTotal').text(Sum.toFixed(2));
        }

        var IsShow = false;
        function GridShow(obj) {
            if (IsShow) {
                $(obj).text('顯示疊構');
                $('.SecondRow').hide();
                IsShow = false;
            }
            else {
                $(obj).text('隱藏疊構');
                $('.SecondRow').show();
                IsShow = true;
            }
        }

        //載入Excel資料
        function SetDataTable(dt) {
            $('#grid > tbody').html('');
            var ErrorMsg = "";
            $.each(dt, function (index, row) {
                var Html = "<tr>";
                 if (row[1] == "Dielectric") {
                    if(IsShow)
                        Html = "<tr class=\"SecondRow\">";
                    else
                        Html = "<tr class=\"SecondRow\" style=\"display:none\">";
                }
                Html += "<td>" + row[0] + "</td>";
                Html += "<td>" + row[1] + "</td>";
                if (row[2] != "BOT" && row[2] != "" && dt[index + 1][2] != "") {
                    ErrorMsg += row[2] + "、";
                    Html += "<td><span style=\"color:red\">" + row[2] + "</span></td>";
                }
                else {
                    Html += "<td>" + row[2] + "</td>";
                }
                Html += "<td>" + row[3] + "</td>";
                Html += "<td>" + row[4] + "</td>";
                Html += "<td>" + row[5] + "</td>";
                Html += "<td>" + row[6] + "</td>";
                Html += "<td>" + row[7] + "</td>";

                $('#grid > tbody').append(Html);
                
            });
            //計算總版厚
            GetTotal();
            if (ErrorMsg == "") {
                //驗證
                SaveCheckFile();
                $('#OpenOnlineEdit').show();
            }
            else {
                $('#ErrorMsg').text(ErrorMsg + "疊構不符，請由原始檔案修改");
                $('#OpenOnlineEdit').hide();
            }
        }

        function uploadFile() {
            if ($('#lefile')[0].files[0]) {
                 $('#FileID').val($('#lefile')[0].files[0].name);
            }

            var formData = new FormData();
            formData.append('file', $('#lefile')[0].files[0]); // myFile is the input type="file" control
            formData.append('datFile', $('#datFile')[0].files[0]); // myFile is the input type="file" control

            var _url = '@Url.Action("UploadFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false,  // tell jQuery not to set contentType
                success: function (result) {
                    if (result.status == "400") {
                        alert(result.ErrorMessage);
                        $('#showCover').text('Choose file');
                    }
                    else {
                        //$('#grid tbody').html(result);
                        SetDataTable(result);

                        CheckNumRule();
                    }
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                    $('#lefile').val('');
                    $('#FileID').val('');
                    $('body').addClass('no-loader');
                }
            });
        }

        function SaveCheckFile() {
            $('#OpenOnlineEdit').hide();
            $('#downloadError').hide();
            $('#downloadCNS').hide();
            $('#downloadExp').hide();

            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};

                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).text();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("SaveCheckFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    $('#ErrorMsg').text(result);

                    if (result != "") {
                        //顯示訊息
                        $('#ErrorMsg').text(result);
                        $('#OpenOnlineEdit').show();
                        $('#downloadError').show();
                    }
                    else {
                        $('#ErrorMsg').text('驗證通過!');
                        $('#downloadCNS').show();
                        $('#downloadExp').show();
                    }
                    
                    $('body').addClass('no-loader');
                },
                error: function (jqXHR) {
                    $('body').addClass('no-loader');
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        function DownloadCheckFile() {
            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};
                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).find('input:eq(0)').val();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("DownloadCheckFile", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    window.location.href = "@Url.RouteUrl(new { Controller = "Excel", Action = "Download" })/?fileName=" + result;
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        function DownloadError() {
            var data = new Array();

            $.each($('#grid tbody tr'), function (index,row) {
                $.each($(row).find('td'), function (colIndex,col) {
                    var StackupDetalList = {};
                    StackupDetalList.IndexNo = index;
                    StackupDetalList.ColumnValue = $(col).text();
                    StackupDetalList.StackupColumnID = (colIndex + 1);
                    data.push(StackupDetalList);
                });
            });

            var ViewModel = { StackupDetalList: data };

            var _url = '@Url.Action("DownloadError", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    //顯示訊息
                    window.location.href = "@Url.RouteUrl(new { Controller = "Excel", Action = "DownloadErrorFile" })/?FileName=" + result + "&RealFileName=" + $('#FileID').val();
                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        var windowObjectReference = null; // global variable

        //開啟編輯
        function ExcelEdit() {

            if (windowObjectReference == null || windowObjectReference.closed) {
                var _url = '@Url.Action("ExcelEdit", "Excel")';

                windowObjectReference = window.open(_url, "_blank");


            } else {
              windowObjectReference.focus();
            };

        }

        var IsShow = false;
        function GridShow(obj) {
            if (IsShow) {
                $(obj).text('顯示疊構');
                $('.SecondRow').hide();
                IsShow = false;
            }
            else {
                $(obj).text('隱藏疊構');
                $('.SecondRow').show();
                IsShow = true;
            }
        }

        //線上編輯用
        function returnData(formData) {


            var _url = '@Url.Action("ExcelReturnData", "Excel")';

            $.ajax({
                url: _url,
                type: 'POST',
                data: JSON.stringify(ViewModel),  //JSON.stringify(model)
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    $('#grid tbody').html(result);
                    //計算總版厚
                    GetTotal();

                },
                error: function (jqXHR) {
                },
                complete: function (jqXHR, status) {
                }
            });
        }

        function AddRow() {
            if ($('#grid').length == 0) {
                alert("請先上傳驗證檔案");
                return;
            }
            var copyrow1 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 4).clone();
            copyrow1.find('td').each(function( index ){
                $(this).find('input').val('');
                $(this).find('input').prop("disabled", false);
            });
            var copyrow2 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 3).clone();
            copyrow2.find('td').each(function( index ){
                $(this).find('input').val('');
                $(this).find('input').prop("disabled", false);
            });
            var copyrow3 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 2).clone();
            var copyrow4 = $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 1).clone();


            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 2).remove();
            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 1).remove();

            $('#grid > tbody').append(copyrow1);
            $('#grid > tbody').append(copyrow2);
            $('#grid > tbody').append(copyrow3);
            $('#grid > tbody').append(copyrow4);
        }

        function DeleteRow() {
            if ($('#grid').length == 0) {
                alert("請先上傳驗證檔案");
                return;
            }

            if ($('#grid > tbody > tr').length <= 5) {
                alert("已沒可刪除資料");
                return;
            }

            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 4).remove();
            $('#grid > tbody > tr').eq($('#grid > tbody > tr').length - 3).remove();
        }
    </script>
}


